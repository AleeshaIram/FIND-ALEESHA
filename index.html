<!DOCTYPE html> 
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Find Aleesha ‚Äî Morocco ‚ûú UK</title>
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<style>
  :root { --ink:#fff; --muted:#cfd5ff; --accent:#ff7ecb; --glass:rgba(0,0,0,.35); }
  html,body { margin:0; background:#0e0f1a; color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; }
  #hud { position:fixed; left:50%; top:10px; transform:translateX(-50%); background:var(--glass); padding:6px 12px; border-radius:999px; font-weight:700; z-index:3 }
  #sub { position:fixed; left:50%; top:46px; transform:translateX(-50%); opacity:.8; font-size:12px; z-index:3 }
  #help { position:fixed; bottom:10px; left:50%; transform:translateX(-50%); opacity:.8; font-size:13px; z-index:3 }

  canvas { display:block; margin:70px auto 48px; max-width:980px; width:92vw; height:auto;
           border:2px solid #2b2e4a; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.5);
           touch-action:none; background:#11152e }

  .overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.65); z-index:12; }
  .card{ width:min(92vw,680px); background:#15172b; border:1px solid #2f3560; border-radius:16px; padding:28px; text-align:center; box-shadow:0 8px 40px rgba(0,0,0,.55); }
  .title{ font-size:26px; font-weight:900; margin:0 0 10px; letter-spacing:.5px }
  .btn{ cursor:pointer; padding:12px 18px; border-radius:999px; background:#6e7bff; color:#fff; border:none; font-weight:800; }
  .row{ display:flex; gap:10px; justify-content:center; margin-top:14px; flex-wrap:wrap }
  .code{ margin:12px auto 0; padding:12px 14px; border-radius:12px; background:#0f1122; border:1px dashed #6e7ffb;
         font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; user-select:all }

  #progWrap{ position:fixed; top:10px; right:60px; width:210px; background:var(--glass); padding:8px 10px; border-radius:12px; z-index:3; }
  #bar{ height:8px; background:#2a2f55; border-radius:999px; overflow:hidden; margin-top:6px }
  #bar>i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#69f,#ff7ecb); transition:width .3s ease; }
  #labels{ display:flex; justify-content:space-between; font-size:12px; opacity:.9 }

  #toast { position:fixed; top:78px; left:50%; transform:translateX(-50%); background:rgba(255,255,255,.08);
           border:1px solid rgba(255,255,255,.18); padding:8px 12px; border-radius:999px; font-weight:700; display:none; pointer-events:none; z-index:9 }

  /* Start poster */
  #start { display:flex; background:rgba(0,0,0,.85); }
  .poster-wrap{ position:relative; width:min(92vw,1100px); aspect-ratio:3/2; }
  .poster { position:absolute; inset:0; width:100%; height:100%; object-fit:contain; image-rendering:pixelated; }
  #startHotspot{ position:absolute; left:50%; transform:translateX(-50%); bottom:7.5%; width:48%; height:12%; background:transparent; border:none; cursor:pointer; }
  #startHotspot:focus-visible{ outline:3px solid #ffd053; border-radius:10px }

  /* Cooking scene */
  #cook { background: rgba(0,0,0,.85); }
  #cookScene{
    position:relative; width:min(1200px,98vw); max-height:90vh; aspect-ratio:16/9;
    background:#000 url("bg_round3.png") center/cover no-repeat;
    border:1px solid #2f3560; border-radius:16px; overflow:hidden; image-rendering:pixelated; touch-action:none;
  }

  #cookGirl{ position:absolute; bottom:7%; left:50%; transform:translateX(-50%); width:240px; image-rendering:pixelated; pointer-events:none; }

#cookHint {
  position: absolute;
  top: 30px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 2;
  display: inline-flex;
  align-items: center;
  gap: 10px;

  font-size: 26px;
  font-weight: 800;
  color: #fff;
  letter-spacing: 0.4px;
  text-shadow: 0 3px 6px rgba(0,0,0,0.5);

  background: rgba(0,0,0,0.45);
  padding: 10px 18px;
  border-radius: 14px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
  transition: transform 0.18s ease, opacity 0.3s ease;
}
#cookHint::after{
  content:"";
  position:absolute; bottom:-8px; left:50%; transform:translateX(-50%);
  width:0; height:0;
  border-left:8px solid transparent;
  border-right:8px solid transparent;
  border-top:8px solid #ffd053;
  filter:drop-shadow(0 2px 0 rgba(0,0,0,.35));
}
@media (max-width: 700px){ #cookHint{ top: 16%; } }
@keyframes hintPulse{ 0%,100%{ transform:translateX(-50%) scale(1); } 50%{ transform:translateX(-50%) scale(1.06); } }

  #woodBoard{ position:absolute; left:0; right:0; bottom:30px; height:80px; background:url("wood.png") center/cover no-repeat; image-rendering:pixelated; pointer-events:none; }
  #cookTable{ position:absolute; left:0; right:0; bottom:0; height:28%; background:transparent; }

  /* Item rail */
  #tableItems{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:10.5%;
    width:min(760px,86%);
    height:130px;
    display:flex; justify-content:space-between; align-items:flex-end; gap:24px;
    z-index:8;
  }
  .itemBtn{
    width:118px; height:118px; display:grid; place-items:center; cursor:grab; background:transparent; border:none; border-radius:12px; padding:0;
    transition: transform .12s ease, filter .12s ease;
  }
  .itemBtn:hover{ transform: translateY(-2px) scale(1.06); }
  .itemBtn.done{ opacity:.35 !important; filter:grayscale(1) saturate(.45) brightness(.9); pointer-events:none; }
  .itemBtn>img{ max-width:96px; max-height:96px; image-rendering:pixelated; pointer-events:none; display:block; }

  /* Bowl & layers */
  #bowlClip{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:16.2%;
    width:200px; height:132px;
    overflow:hidden;
    border-radius:50% / 58%;
    pointer-events:none;
  }
  .layer{ position:absolute; left:50%; transform:translateX(-50%); width:150px; height:86px; pointer-events:none; display:none; image-rendering:pixelated; transition: transform .12s ease, opacity .15s ease; }
  #layer-butter{ bottom:44%; background:url("tiny_butter.png") center/contain no-repeat; }
  #layer-sugar { bottom:45%; background:url("brown_sugar_pile.png") center/contain no-repeat; transform:translateX(-50%) scale(.95); }
  #layer-egg   { bottom:43%; background:url("raw_egg.png") center/contain no-repeat; }
  #layer-flour { bottom:45%; background:url("flour_pile.png") center/contain no-repeat; opacity:.98; }
  #layer-chips { bottom:45%; background:url("choc_chips.png") center/contain no-repeat; transform:translateX(-50%) scale(.95); }

  /* Hotspot + glow */
  #bowlHotspot{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:15.8%; width:220px; height:140px; border-radius:50%;
    touch-action:none; z-index:6; pointer-events:none;
  }
  #bowlHotspot.active{ pointer-events:auto; }
  #bowlGlow{ position:absolute; inset:0; border-radius:50%;
    box-shadow:0 0 0 3px rgba(255,255,255,.12) inset; opacity:0; transition:.2s; }
  #bowlHotspot.pulse #bowlGlow{ animation:pulse 1s infinite; opacity:.5; }
  #bowlHotspot.magnet #bowlGlow{
    opacity:.9; box-shadow:0 0 0 3px rgba(255,255,255,.20) inset, 0 0 16px rgba(255,255,255,.25);
  }
  @keyframes pulse { 0%,100%{opacity:.35} 50%{opacity:.6} }

  #crackFX { position:absolute; left:50%; bottom:25%; transform:translateX(-50%); width:140px; height:90px; display:none;
             background:url("cracked_egg.png") center/contain no-repeat; image-rendering:pixelated; }

  /* Mixed dough */
  #dough{
    position:absolute; left:50%; top:auto; transform:translate(-50%,0);
    bottom:17.2%;
    width:150px; height:128px;
    background:url("dough.png") center 60% / 100% 100% no-repeat;
    border-radius:90px/60px;
    box-shadow:0 2px 0 #4a2b13 inset, 0 -2px 0 #e2b680 inset;
    opacity:0; display:none; image-rendering:pixelated;
    transition: opacity .15s linear, background-position .08s linear;
    -webkit-mask: radial-gradient(85% 96% at 50% 60%, #000 74%, #0000 76%);
            mask: radial-gradient(85% 96% at 50% 60%, #000 74%, #0000 76%);
  }
  #dough::before{
    content:""; position:absolute; inset:6% 6% 10% 6%; border-radius:inherit;
    background:
      conic-gradient(
        rgba(255,255,255,.12) 0 25%,
        transparent 25% 50%,
        rgba(0,0,0,.10) 50% 75%,
        transparent 75% 100%
      );
    mix-blend-mode: overlay; transform: rotate(var(--swirlDeg, 0deg)); pointer-events:none; opacity:.65;
  }
  #dough::after{
    content:""; position:absolute; inset:0; border-radius:inherit;
    background:
      radial-gradient(120% 90% at 20% 20%, rgba(255,255,255,.08), transparent 60%),
      radial-gradient(140% 100% at 70% 80%, rgba(0,0,0,.10), transparent 60%);
    transform: rotate(var(--swirlDeg, 0deg)); pointer-events:none; opacity:.8;
  }

  #stirRing{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:18%; width:210px; height:128px;
    border-radius:50%; border:2px dashed rgba(255,255,255,.28); display:none;
  }
  #stirText{ position:absolute; left:50%; transform:translateX(-50%); bottom:42%; font-weight:800; background:rgba(0,0,0,.4); padding:6px 10px; border-radius:8px; display:none; }

  /* Heads */
  #heads{ position:fixed; inset:0; pointer-events:none; z-index:3 }
  .head{ position:fixed; width:48px; height:48px; image-rendering:pixelated; border-radius:10px; background:#00000055; border:1px solid #32365f; box-shadow:0 4px 14px rgba(0,0,0,.5); object-fit:contain; padding:4px; }
  #headAleesha{ display:none; }
  #headFatt{ right:10px; top:10px; }

  /* Dialog */
  #dlg{ background:rgba(0,0,0,.65); display:none; align-items:center; justify-content:center; z-index:20; }
  #dlg .dlg-wrap{ position:relative; width:min(820px,92vw); aspect-ratio:16/10; image-rendering:pixelated; }
  #dlgBubble{ position:absolute; inset:0; width:100%; height:100%; object-fit:contain; image-rendering:pixelated; z-index:0; filter:none; }
  #dlgText{
    position:absolute; inset:18% 16% 36% 28%;
    display:flex; align-items:flex-start; justify-content:center; text-align:center;
    font-family:"VT323", monospace;
    font-size:clamp(18px, 2.0vw, 30px);
    line-height:1.08; letter-spacing:.5px; color:#000;
    white-space:pre-line; overflow:hidden; word-break:break-word; overflow-wrap:anywhere; text-wrap:balance;
    z-index:1; pointer-events:none;
  }
  #dlgNext{ position:absolute; left:50%; transform:translateX(-50%); bottom:6%; z-index:2; }

  /* Game Over bubble */
  #over .dlg-wrap { position: relative; width: min(820px, 92vw); aspect-ratio: 16/10; image-rendering: pixelated; display:flex; align-items:center; justify-content:center; }
  #overBubble { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; z-index: 0; }
  #overText { position: absolute; inset: 20% 16% 34% 20%; display:flex; align-items:flex-start; justify-content:center; text-align:center; font-family:"VT323", monospace; font-size:clamp(20px,2.3vw,32px); line-height:1.08; color:#000; white-space:pre-line; overflow-wrap:anywhere; z-index:1; }
  #overBtns { position: absolute; left:50%; transform:translateX(-50%); bottom:8%; z-index:2; }

  /* Oven overlays */
  #ovenClock{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(32vw,220px); display:none; image-rendering:pixelated; z-index:5; }
  #sleepImg{ position:absolute; left:50%; bottom:2%; transform:translateX(-50%); width:min(50vw,420px); display:none; image-rendering:pixelated; z-index:5; }

/* Full-screen scroll letter */
#letter{
  background: rgba(0,0,0,.80);
  display:none; align-items:center; justify-content:center;
  z-index:30;
}
#letterWrap{
  position:relative;
  /* make it huge: prioritize viewport height so it "fills" the screen */
  height: min(92vh, 1100px);
  width: min(96vw, 2000px);
  aspect-ratio: 16 / 9;              /* wide parchment vibe */
}
#letterImg{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:contain; image-rendering:pixelated;
}

#letterText{
  position:absolute;
  inset: 16% 22% 16% 25%;             /* top / right / bottom / left */
  font-family:'VT323', monospace;
  font-size: clamp(20px, 2.5vw, 38px); /* scale with size */
  line-height: 1.28;
  text-align:center;
  color:#2b1a0b;
  text-shadow: 0 1px 1px rgba(255,255,255,.5);
  overflow:auto;
}

#letterBtn{
  position:absolute;
  left:50%; transform:translateX(-50%);
  bottom: 6%;
  padding: 14px 24px;
  font-size: clamp(14px, 1.6vw, 20px);
}

  #cookScene, #cookScene * { -webkit-user-select:none; user-select:none; }
  #stirRing, #stirText { pointer-events:none; }
  #bowlHotspot { z-index:6; }
  #stirRing    { z-index:5; }
  #stirText    { z-index:7; }
  #tableItems  { z-index:2; }
</style>
</head>
<body>

<div id="heads" aria-hidden="true">
  <img id="headAleesha" class="head" src="aleeshahead.png" alt="">
  <img id="headFatt" class="head" src="aleeshahead.png" alt="">
</div>

<div id="hud">
  Score: <span id="score">0</span> ‚Ä¢ High: <span id="high">0</span> ‚Ä¢ Jumps: <span id="jumps">0</span> ‚Ä¢ Round: <span id="round">1</span>
</div>
<div id="sub">Click / press SPACE to jump ‚Ä¢ You stink btw pewieeee</div>

<div id="progWrap" aria-label="Progress">
  <div id="labels"><span>0</span><span>65</span></div>
  <div id="bar"><i id="barFill"></i></div>
</div>

<div id="toast"></div>

<canvas id="game" width="900" height="520" aria-label="Find Aleesha runner"></canvas>
<div id="help">Obstacles: the gazzillion cats in morocco, I am jealous :( </div>

<!-- START -->
<div id="start" class="overlay" role="dialog" aria-modal="true" style="display:flex">
  <div class="poster-wrap" aria-label="Find Aleesha start poster">
    <img class="poster" src="poster.png" alt="Find Aleesha start poster" />
    <button id="startHotspot" aria-label="Start Game"></button>
  </div>
</div>

<!-- DIALOG -->
<div id="dlg" class="overlay" role="dialog" aria-modal="true">
  <div class="dlg-wrap">
    <img id="dlgBubble" src="bubble.png" alt="">
    <p id="dlgText">‚Ä¶</p>
    <button class="btn" id="dlgNext">Continue</button>
  </div>
</div>

<!-- COOKING -->
<div id="cook" class="overlay" role="dialog" aria-modal="true">
  <div id="cookScene">
    <div id="cookHint"><b>üßà butter first</b></div>

    <img id="cookGirl" src="baking_girl.png" alt="chef girl">

    <div id="bowlClip">
      <div id="layer-butter" class="layer"></div>
      <div id="layer-sugar"  class="layer"></div>
      <div id="layer-egg"    class="layer"></div>
      <div id="layer-flour"  class="layer"></div>
      <div id="layer-chips"  class="layer"></div>
      <div id="dough"></div>
    </div>

    <div id="bowlHotspot" aria-label="Bowl drop & stir zone"><div id="bowlGlow"></div></div>
    <div id="crackFX"></div>

    <div id="stirRing"></div>
    <div id="stirText">Stir in circles!</div>

    <div id="cookTable"></div>
    <div id="woodBoard"></div>
    <div id="tableItems"></div>

    <img id="ovenClock" alt="clock">
    <img id="sleepImg" alt="asleep">

    <button class="btn" id="exitCook" style="position:absolute; right:10px; top:10px; background:#444a; border:1px solid #666">Back to running</button>
  </div>
</div>

<!-- WIN (gift card + continue) -->
<div id="win" class="overlay" role="dialog" aria-modal="true">
  <div class="card">
    <p class="title">üéâ Ok you actually did it, you finally got to the UK and now, you can keep running forever.</p>
    <p style="opacity:.9">Happy BIRTHDAY, my Moroccan queen. Here‚Äôs your gift hehe:</p>
    <div class="code" id="gift">SHEIN Numero de carte: 1113517585647802450   PIN: 5763</div>
    <div class="row">
      <button class="btn" id="copy">Copy code</button>
      <button class="btn" id="winContinue">Continue</button>
      <button class="btn" id="closeWin">Close</button>
    </div>
    <p style="opacity:.8; font-size:12px; margin-top:10px">Tip: press G anytime to reopen this.</p>
  </div>
</div>

<!-- GAME OVER -->
<div id="over" class="overlay" role="dialog" aria-modal="true">
  <div class="dlg-wrap">
    <img id="overBubble" src="bubble_2.png" alt="">
    <p id="overText">YOU KILLED THE CAT, HOW DARE YOU?!<br>Tip: Jump better dumbass.</p>
    <div id="overBtns" class="row">
      <button class="btn" id="retry">Retry</button>
      <button class="btn" id="retryCp">Retry from checkpoint</button>
    </div>
  </div>
</div>

<!-- LOVE LETTER (single, not duplicated) -->
<div id="letter" class="overlay" role="dialog" aria-modal="true">
  <div id="letterWrap">
    <img id="letterImg" src="letter.png" alt="love letter">
    <div id="letterText"></div>
    <button id="letterBtn" class="btn">Continue</button>
  </div>
</div>

<script>
(() => {
  /* ===== Speaker bubble layout + helpers ===== */
  const SPEAKER_LAYOUT = {
    aleesha: { inset: "22% 12% 34% 18%", size: "clamp(26px,3.6vw,52px)" },
    fatt:    { inset: "28% 14% 38% 20%", size: "clamp(22px,2.8vw,40px)" }
  };
  function parseInset(str){
    const p = (str||"").trim().split(/\s+/).map(v=>v.endsWith("%")?parseFloat(v):parseFloat(v));
    while (p.length<4) p.push(p[p.length-1] ?? 0);
    return p.slice(0,4);
  }
  function fmtInset(a){ return `${a[0]}% ${a[1]}% ${a[2]}% ${a[3]}%`; }

  const dlgEl   = document.getElementById("dlg");
  const dlgText = document.getElementById("dlgText");
  const dlgNext = document.getElementById("dlgNext");
  const dlgBubble = document.getElementById("dlgBubble");

  function showSpeak(who, txt, onNext, opts = {}){
    const skin = opts.skin || who;
    dlgBubble.src = skin === "aleesha" ? "bubble_aleesha.png"
                 : skin === "fatt"    ? "bubble_fatt.png"
                 :                      "bubble.png";
    const base = SPEAKER_LAYOUT[who] || {};
    const insetStr = (opts.inset || base.inset || "18% 16% 36% 28%");
    let insetArr = parseInset(insetStr);
    if (opts.nudge){
      const n = opts.nudge;
      if (n.top   != null) insetArr[0] += n.top;
      if (n.right != null) insetArr[1] += n.right;
      if (n.bottom!= null) insetArr[2] += n.bottom;
      if (n.left  != null) insetArr[3] += n.left;
    }
    dlgText.textContent = txt;
    dlgText.style.inset = fmtInset(insetArr);
    dlgText.style.fontSize = opts.size || base.size || "clamp(18px,2.2vw,30px)";
    modalActive = true;
    dlgEl.style.display = "flex";
    requestAnimationFrame(fitDlgText);
    dlgNext.onclick = () => {
      dlgEl.style.display = "none";
      modalActive = false;
      dlgText.style.lineHeight = "1.08";
      onNext && onNext();
    };
  }
  function showDlg(txt, onNext, opts = {}){
    dlgBubble.src = "bubble.png";
    dlgText.textContent = txt;
    dlgText.style.inset = opts.inset || "18% 16% 36% 28%";
    dlgText.style.fontSize = opts.size || "clamp(18px,2.2vw,30px)";
    modalActive = true;
    dlgEl.style.display = "flex";
    requestAnimationFrame(fitDlgText);
    dlgNext.onclick = () => {
      dlgEl.style.display = "none";
      modalActive = false;
      dlgText.style.lineHeight = "1.08";
      onNext && onNext();
    };
  }
  const say = (who, text, onNext, opts) => showSpeak(who, text, onNext, opts);

  /* Inject love letter text */
  const letterText = document.getElementById("letterText");
  if (letterText){
    letterText.innerHTML = 
`HAPPY 20TH BIRTHDAY MY LOVE!! üíï<br>
You aren‚Äôt a teenager anymore, you‚Äôre officially stepping into a whole new era of life, and I feel so privileged to be a part of it :( <br>
I am just so proud of the woman you‚Äôve become. ü§ç<br><br>

It honestly feels so surreal that I got to watch you grow, from the people-pleaser, overthinker, soft-hearted girl you were, into this confident, radiant, and grounded woman that you are now.<br>
You‚Äôve always had the kindest soul, but now you carry it with this strength and self-assurance that makes me so proud, it actually hurts. üò≠<br>
It's because you're not fake, and it is obvious because you make people <i>feel</i> loved.<br><br>

You are also the EMBODIMENT of Pinterest to me, everything about you is so aesthetic, thoughtful, and full of love.<br>
Any time I see a new profile picture, I always have to double check it's not something you stole off Instagram. <br><br>

The way you put effort and warmth into everything you do, your friendships, the way you communicate with your words, and even the little things like when you vlog hehe.<br>
It just makes my whole day.<br>
I love (and miss) the vlogs so much üò≠<br><br>

And I know we always say this, but I miss when we used to send those long-ass voice notes about everything and nothing, and we should go back to it.<br>
But I get it, we‚Äôre both annoying adults now, busy chasing our own things.<br>
Still, you cross my mind so often, and you‚Äôll always have a special place there. üíó<br><br>

BTW my friends all played the game and they‚Äôre WAITING for your reaction!!<br>
They said if you don‚Äôt cry, we‚Äôre attacking you BAHHAHAHA üíÄ<br>
But honestly, the older we get, the more I know that one day, In Shaa Allah, I‚Äôll come to Morocco and we‚Äôll make that game a reality.<br>
I can already picture it!!‚ú®<br><br>

Fatima, I love you so, so much.<br>
I pray that Allah SWT blesses every step you take in this new chapter, that He fills your life with barakah, peace, love, and success in everything you do.<br>
You deserve nothing less than the absolute best. üïäÔ∏è<br><br>

You‚Äôre my <i>mon amour</i> forever <3<br>
Love, your Leeshie ü§ç<br>

P.S. I think Tima is a sexcy ass woman ;)`;
  }

  const GIFT_CODE = "SHEIN Numero de carte: 1113517585647802450   PIN: 5763";
  const ROUND2_AT = 20;
  const ROUND3_AT = 40;
  const ROUND4_JUMPS_GOAL = 25;
  const JUMPS_GOAL_TOTAL = 65; // progress target
  let progressBase = 0;        // base progress carried across rounds

  const BASE_SPEED = 4.8;
  const GRAVITY = 0.4;
  const JUMP_VEL = -12;

  const FLOOR_Y = 550;
  const FOOT_OFFSET = 0;

  const VERY_FAR_MIN = 380, VERY_FAR_MAX = 620;
  const FAR_MIN      = 300, FAR_MAX      = 520;
  const MID_MIN      = 220, MID_MAX      = 360;

  const SPRITE_FRAMES = 4;
  let SPRITE_LAYOUT = "horizontal";

  const FATT_W  = 56;
  const FATT2_W = 52;
  const FATT3_W = 58;

  const CATS = [
    { src:"cat1.png", h: 80 }, { src:"cat2.png", h: 80 }, { src:"cat3.png", h: 70 },
    { src:"cat4.png", h: 80 }, { src:"cat5.png", h: 80 }
  ];
  const catImgs = CATS.map(c => {
    const img = new Image(); img.src = c.src;
    img.onload = () => { c.nw = img.naturalWidth; c.nh = img.naturalHeight; };
    return { ...c, img };
  });

  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;
  let theight = canvas.height;

  function resizeCanvas(){
    const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    const w = canvas.clientWidth;
    theight = canvas.clientHeight || canvas.height;
    canvas.width  = Math.round(w * dpr);
    canvas.height = Math.round(theight * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    computeBgTileW();
    layoutBakery();
    if (dlgEl.style.display === "flex") fitDlgText();
  }
  window.addEventListener('resize', resizeCanvas);

  const scoreEl = document.getElementById("score");
  const highEl  = document.getElementById("high");
  const jumpsEl = document.getElementById("jumps");
  const roundEl = document.getElementById("round");
  const barFill = document.getElementById("barFill");
  const progWrap = document.getElementById("progWrap");
  const startEl = document.getElementById("start");
  const startHotspot = document.getElementById("startHotspot");
  const winEl   = document.getElementById("win");
  const overEl  = document.getElementById("over");
  const cookEl  = document.getElementById("cook");
  const toastEl = document.getElementById("toast");
  const retryCpBtn = document.getElementById("retryCp");
  const letterEl = document.getElementById("letter");
  const letterImgEl = document.getElementById("letterImg");
  if (letterImgEl) letterImgEl.src = "scroll.png?v=2";

  document.getElementById("gift").textContent = GIFT_CODE;

  const bgImg   = new Image(); bgImg.src   = "bg_round1.png";
  const bg2Img  = new Image(); bg2Img.src  = "bg_round2.png";
  const bg3Img  = new Image(); bg3Img.src  = "bg_round3.png";
  const bg4Img  = new Image(); bg4Img.src  = "bg_round4.png";

  const heroR1 = new Image(); heroR1.src = "fatt.png";
  const heroR2 = new Image(); heroR2.src = "fatt2.png";
  const heroR3 = new Image(); heroR3.src = "fatt3.png";

  const bakeryImg = new Image(); bakeryImg.src = "closed_bakery.png";
  const presentImg = new Image(); presentImg.src = "present.png";
  const openPresentImg = new Image(); openPresentImg.src = "open_present.png";
  const aleeshaImg = new Image(); aleeshaImg.src = "Aleesha1.png";

  let heroReady=false, heroImg = heroR1;
  let frame=0, frameTimer=0, frameW=0, frameH=0;
  const FRAME_TIME = 120;

  let heroAlpha = 1;
  const player = { x:120, y: FLOOR_Y - 56 + FOOT_OFFSET, w:56, h:56, vy:0, onGround:true };
  const aleesha = { x: 0, y: 0, w: 60, h: 60, visible: false };

  let highScore = Number(localStorage.getItem("catRunnerHighScore") || 0);
  highEl.textContent = highScore;

  function applySprite(img, targetW){
    heroReady = true;
    const w = img.naturalWidth, h = img.naturalHeight;
    if (w >= h * (SPRITE_FRAMES - 0.5)) SPRITE_LAYOUT = "horizontal";
    else if (h >= w * (SPRITE_FRAMES - 0.5)) SPRITE_LAYOUT = "vertical";
    frameW = (SPRITE_LAYOUT === "horizontal") ? Math.round(w / SPRITE_FRAMES) : w;
    frameH = (SPRITE_LAYOUT === "vertical")   ? Math.round(h / SPRITE_FRAMES) : h;
    player.w = targetW;
    player.h = Math.round(player.w * (frameH / frameW));
    player.y = FLOOR_Y - player.h + FOOT_OFFSET;
  }
  heroR1.onload = () => { heroImg = heroR1; applySprite(heroR1, FATT_W); };

  let started = false;
  let running=false, dead=false, winUnlocked=false;
  let endless = false;   // after love letter, run forever
  let awaitingRound2=false;
  let bakeryDone = false;
  let round = 1;

  let tLast=0, bgX=0, score=0, jumps=0;
  let obstacles=[];

  let modalActive = false;

  const CUT = { NONE:0, AWAIT_POPUP:1, APPROACH:2, ENTERING:3, DONE:4 };
  let cutState = CUT.NONE;
  const bakery = { visible:false, doorX:0, doorY:0, w:0, h:0 };
  let walkTargetX = 0;
  let sparkles = [];

  let presentScene = false;
  let presentCutsceneDone = false;
  const present = { x:0, y:0, w:64, h:64 };
  let presentOpened = false;

  let fog = [];
  let confetti = [];

  function seedFog(){
    fog = [];
    const W = canvas.clientWidth, H = canvas.clientHeight || canvas.height;
    const N = 22;
    for (let i=0;i<N;i++){
      fog.push({ x: Math.random()*W, y: Math.random()*H*0.7, r: 80 + Math.random()*160, a: 0.08 + Math.random()*0.08, vx: -0.15 - Math.random()*0.25 });
    }
  }
  function burstConfetti(cx, cy){
    confetti.length = 0;
    const colors = ["#ffd053","#ff7ecb","#69f","#7dffb7","#ffad5a"];
    for (let i=0;i<60;i++){
      confetti.push({ x: cx, y: cy, vx: (Math.random()*3-1.5), vy: -(2 + Math.random()*3), rot: Math.random()*Math.PI*2, vr: (Math.random()*0.2-0.1),
        life: 1200 + Math.random()*800, w: 3 + Math.random()*3, h: 6 + Math.random()*6, color: colors[(Math.random()*colors.length)|0] });
    }
  }

  let storm=false, flashAlpha = 0, shakeTime = 0, lastLightningMs = 0, nextLightningMs = 1200 + Math.random()*2200;
  const RAIN_COUNT = 140;
  const rain = [];
  function seedRain(){
    rain.length = 0;
    const W = canvas.clientWidth, H = canvas.clientHeight || canvas.height;
    for(let i=0;i<RAIN_COUNT;i++){ rain.push({ x: Math.random()*W, y: Math.random()*H, len: 8 + Math.random()*12, spd: 7 + Math.random()*5 }); }
  }

  let bgTileW = 900;
  function computeBgTileW(){
    const bg = currentBg();
    const H = canvas.clientHeight || canvas.height;
    if (bg && bg.complete && bg.naturalWidth>0 && H){
      const scale = H / bg.naturalHeight;
      bgTileW = (Math.ceil(bg.naturalWidth * scale) | 0);
    }
  }
  ;[bgImg,bg2Img,bg3Img,bg4Img].forEach(i => i.onload = computeBgTileW);

  const DOOR_X_FRAC = 0.78, DOOR_Y_FRAC = 0.79;
  function layoutBakery(){
    const W = canvas.clientWidth, H = canvas.clientHeight || canvas.height;
    bakery.w = W; bakery.h = H;
    bakery.doorX = Math.round(W * DOOR_X_FRAC);
    bakery.doorY = Math.round(H * DOOR_Y_FRAC);
  }
  bakeryImg.onload = layoutBakery;

  function hud(showIt){ progWrap.style.display = showIt ? "block" : "none"; }

  const uiToHide = ["hud", "progWrap", "sub", "help"];
  function hideGlobalUI(){ uiToHide.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = "none"; }); }
  function showGlobalUI(){ uiToHide.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = ""; }); }

  /* Bubble helpers */
  function fitDlgText(){ const el=dlgText; let size=parseFloat(getComputedStyle(el).fontSize)||24; const min=12; let lh=1.08;
    for (let i=0;i<50;i++){ if (el.scrollWidth<=el.clientWidth && el.clientHeight>=el.scrollHeight) break;
      if (size>min){ size-=1; el.style.fontSize=size+"px"; } else { lh=Math.max(0.98, lh-0.02); el.style.lineHeight=lh.toString(); } } }
  function showContinueOnly(onNext){
    modalActive=true; dlgText.textContent=""; dlgText.style.display="none"; dlgBubble.style.display="none";
    const prevBg=dlgEl.style.background; dlgEl.style.background="transparent"; dlgEl.style.display="flex";
    dlgNext.onclick=()=>{ dlgEl.style.display="none"; dlgEl.style.background=prevBg||""; dlgBubble.style.display=""; dlgText.style.display=""; modalActive=false; onNext&&onNext(); };
  }

  /* Input */
  function setProgress(){
    const base = Number.isFinite(progressBase) ? progressBase : 0;
    const total = Math.min(JUMPS_GOAL_TOTAL, base + jumps);
    barFill.style.width = Math.round((total / JUMPS_GOAL_TOTAL) * 100) + "%";
  }
  function bumpBase(to){
    if (to > progressBase){
      progressBase = to;
      setProgress();
    }
  }

  function jump(){
    if (!started || dead || cutState !== CUT.NONE || inCooking || modalActive) return;
    if (player.onGround){
      player.vy = JUMP_VEL; player.onGround = false;
      jumps++; jumpsEl.textContent = jumps;
      setProgress(); // update bar on each jump

      if (round === 4 && jumps >= ROUND4_JUMPS_GOAL && !presentCutsceneDone && !presentScene){
        running = false;
        showDlg("There is something on the path‚Ä¶", () => {
          const W = canvas.clientWidth, H = canvas.clientHeight || canvas.height;
          present.w = 64;
          present.h = Math.round(64 * 1.0);
          present.x = Math.round(W * 0.78);
          present.y = FLOOR_Y - present.h;
          presentScene = true;
          presentOpened = false;
          seedFog();
          walkTargetX = Math.max(40, present.x - Math.round(player.w * 0.9));
          cutState = CUT.APPROACH;
        }, { inset:"26% 16% 36% 20%", size:"clamp(18px,2.4vw,30px)" });
        return;
      }

      if (deserter.active){ deserter.count++; if (deserter.count >= deserter.limit){ running = false; showDeserterSequence(); } }
    }
    begin();
  }
  window.addEventListener("keydown", e => {
    if (!started && (e.code==="Space" || e.code==="Enter")){ e.preventDefault(); startGame(); return; }
    if (e.code==="Space"||e.code==="ArrowUp"){ e.preventDefault(); jump(); }
    if (e.key==="g"||e.key==="G"){ if (winUnlocked) show(winEl); }
  });
  canvas.addEventListener("pointerdown", e => { if (!started){ startGame(); return; } e.preventDefault(); jump(); });

  /* Loop */
  function begin(){ if(!running && !dead && cutState===CUT.NONE && !awaitingRound2 && !inCooking && !modalActive){ running=true; tLast=0; requestAnimationFrame(loop); } }
  function loop(ts){
    if(!running && cutState===CUT.NONE){ draw(); return requestAnimationFrame(loop); }
    const dt = tLast ? (ts - tLast) : 16; tLast = ts;
    update(dt, dt/16.6667, ts);
    draw();
    requestAnimationFrame(loop);
  }

  /* Start/Reset */
  function reset(){
    [winEl,overEl,cookEl,toastEl,dlgEl,letterEl].forEach(hide);
    running=false; dead=false; winUnlocked=false; awaitingRound2=false; modalActive=false;

    storm=false; flashAlpha=0; shakeTime=0; lastLightningMs=0; nextLightningMs=1200+Math.random()*2200;

    cutState = CUT.NONE; bakery.visible=false; sparkles.length=0; heroAlpha = 1;

    deserter.active=false; deserter.count=0;

    round = 1; roundEl.textContent = "1";

    heroImg = heroR1;
    if (heroR1.complete) applySprite(heroR1, FATT_W); else heroR1.onload = () => applySprite(heroR1, FATT_W);

    tLast=0; bgX=0; score=0; jumps=0;
    obstacles.length = 0;
    player.vy=0; player.onGround=true; player.x = 120;
    player.y = FLOOR_Y - player.h + FOOT_OFFSET;
    scoreEl.textContent = "0"; jumpsEl.textContent = "0";
    setProgress(); // reset bar to 0%

    presentScene = false;
    presentOpened = false;
    presentCutsceneDone = (round >= 4);
    fog = []; confetti = [];

    computeBgTileW();
    resizeCanvas();
    hud(false);
    draw();
  }
  function startGame(){
    if (started) return;
    started = true;
    hide(startEl);
    reset();
    hud(true);
    begin();
  }
  startHotspot.onclick = (e)=>{ e.preventDefault(); startGame(); };

  /* Spawning */
  function pick(min, max){ return Math.floor(min + Math.random() * (max - min)); }

  let nextGapPx = 0;
  function computeNextGap(){
    const { min, max } = gapRangeFor(score, round);
    let gap = pick(min, max);
    if (round === 4 && Math.random() < 0.42) gap += pick(160, 320);
    return gap;
  }
  function gapRangeFor(score, round){
    let min, max;
    if (score < 5){       min = VERY_FAR_MIN; max = VERY_FAR_MAX; }
    else if (score < 15){ min = FAR_MIN;      max = FAR_MAX;      }
    else {                min = MID_MIN;      max = MID_MAX;      }
    let scale = 1;
    if (round === 2) scale = 0.98;
    else if (round === 3) scale = 0.96;
    else if (round === 4) scale = 0.94;
    return { min: Math.round(min * scale), max: Math.round(max * scale) };
  }
  function getWorldSpeed(){ return BASE_SPEED + (round === 4 ? 1 : 0); }

  function spawnCatObstacle(){
    const c = catImgs[rand(0, catImgs.length - 1)];
    const nh = c.nh || 64, nw = c.nw || 64;
    let h = c.h; const s = h / nh; let w = Math.round(nw * s); h = Math.round(h);
    const maxH = 150; if (h > maxH){ const k = maxH/h; h = Math.round(h*k); w = Math.round(w*k); }
    obstacles.push({ x: canvas.clientWidth + 10, y: FLOOR_Y - h, w, h, img: c.img, passed:false });
  }

  /* Round 3 intro */
  function startRound3CutsceneIntro(){
    running = false; hud(false);
    cutState = CUT.AWAIT_POPUP;
    obstacles.length = 0;
    showDlg(
      "OMG wait‚Ä¶\nwhat is that in the distance?",
      () => {
        bakery.visible = true;
        layoutBakery();
        walkTargetX = Math.max(40, bakery.doorX - Math.round(player.w*2.3));
        cutState = CUT.APPROACH;
      },
      { inset:"18% 14% 36% 20%", size:"clamp(22px,2.6vw,32px)" }
    );
  }

  function spawnSparkles(cx, cy){
    sparkles = [];
    for(let i=0;i<14;i++){
      sparkles.push({
        x: cx + (Math.random()*26-13),
        y: cy + (Math.random()*20-16),
        vx: (Math.random()*1.4-0.7),
        vy: (-1.2 - Math.random()*1.2),
        life: 900 + Math.random()*500
      });
    }
  }

  /* Update */
  function update(dtMs, step, nowMs){
    const worldSpeed = (cutState===CUT.NONE && !modalActive) ? getWorldSpeed() : 0;

    bgX -= worldSpeed * step;
    if (bgX <= -bgTileW) bgX += bgTileW;

    if (cutState === CUT.NONE && !modalActive){
      const last = obstacles[obstacles.length - 1];
      const lastRight = last ? (last.x + last.w) : -Infinity;
      if (nextGapPx === 0) nextGapPx = computeNextGap();
      const distanceSinceLast = canvas.clientWidth - lastRight;
      if (!last || distanceSinceLast > nextGapPx){
        spawnCatObstacle();
        nextGapPx = computeNextGap();
      }
    }

    for (let i=obstacles.length-1;i>=0;i--){
      const o = obstacles[i];
      o.x -= worldSpeed*step;
      if (!o.passed && o.x + o.w < player.x){ o.passed = true; score++; scoreEl.textContent = score; }
      if (o.x + o.w < -20) obstacles.splice(i,1);
    }

    if (!modalActive && round === 1 && !awaitingRound2 && score >= ROUND2_AT){
      awaitingRound2 = true; running = false; hud(false);
      showDlgSequence(
        [
          { text:"THUNDERSTORM\nINCOMING!!", inset:"19% 14% 37% 20%", size:"clamp(24px,2.8vw,38px)" },
          { text:"HA HA you just got hit by\nlightning bro. Now you're even\nshorter than normal lol.", inset:"18% 16% 34% 22%", size:"clamp(20px,2.4vw,30px)" },
          { text:"\"RUN BRO!\"\n\"FIND SHELTER NOWW!!\"", inset:"21% 16% 33% 22%", size:"clamp(22px,2.6vw,36px)" }
        ],
        startRound2
      );
    }

    if (!modalActive && !deserter.active && round === 2 && !bakeryDone && cutState===CUT.NONE && score >= ROUND3_AT && !inCooking){
      bakeryDone = true;
      startRound3CutsceneIntro();
    }

    if (cutState===CUT.NONE){
      if (!modalActive){
        player.vy += GRAVITY*step;
        player.y  += player.vy*step;
        if (player.y + player.h >= FLOOR_Y + FOOT_OFFSET){
          player.y = FLOOR_Y - player.h + FOOT_OFFSET;
          player.vy = 0; player.onGround = true;
        }
      }
    } else {
      if (cutState===CUT.APPROACH){
        const dx = walkTargetX - player.x;
        const dir = Math.sign(dx);
        const maxMove = (presentScene ? 0.06 : 0.11) * dtMs;
        const move = dir * Math.min(Math.abs(dx), maxMove);
        player.x += move;
        player.y = FLOOR_Y - player.h + FOOT_OFFSET;

        if (Math.abs(dx) <= maxMove){
          player.x = walkTargetX;

          if (presentScene){
            presentCutsceneDone = true;
            cutState = CUT.DONE;

            spawnSparkles(present.x, present.y - 22);
            presentOpened = true;
            burstConfetti(present.x, present.y - 10);

            // spawn Aleesha next to the present (robust sizing)
            aleesha.visible = true;
            const nh = aleeshaImg.naturalHeight || 100;
            const nw = aleeshaImg.naturalWidth  || 100;
            aleesha.h = Math.round(player.h * 1.1);
            aleesha.w = Math.round(aleesha.h * (nw / nh));
            aleesha.x = present.x + present.w + 3;
            aleesha.y = FLOOR_Y - aleesha.h + FOOT_OFFSET;

            if (!aleeshaImg.complete || !aleeshaImg.naturalWidth){
              aleeshaImg.onload = () => {
                if (!aleesha.visible) return;
                const nh2 = aleeshaImg.naturalHeight || nh;
                const nw2 = aleeshaImg.naturalWidth  || nw;
                aleesha.h = Math.round(player.h * 1.1);
                aleesha.w = Math.round(aleesha.h * (nw2 / nh2));
                aleesha.x = present.x + present.w + 3;
                aleesha.y = FLOOR_Y - aleesha.h + FOOT_OFFSET;
              };
            }

            say("fatt","AAAAAH ITS ALEESHA!!!", () => {
              say("aleesha",
                "OMG YOU ACTUALLY MADE IT\nHERE? I didn't think you\nwould. Wait what is that\nin ur hands.",
                () => {
                  say("fatt",
                    "I may have baked\nsomething special\nfor youuu",
                    () => {
                      say("aleesha",
                        "OMG COOKIES, let me try...\n...seems like you got creative\naha ha ha...don't do that again :)\nBut I have something even better\nfor you hehe",
                        () => {
                          winUnlocked = true;
                          show(winEl);
                        },
                        { size:"clamp(26px,3.6vw,52px)", nudge:{ top:9, left:-8 } }
                      );
                    },
                    { size:"clamp(24px,3vw,44px)", nudge:{ top:-1 } }
                  );
                },
                { size:"clamp(26px,3.6vw,52px)", nudge:{ left:-9, top:6 } }
              );
            }, { size:"clamp(24px,3vw,44px)", nudge:{ left:2} });
            /* ^^^ fixed stray extra "};" here */

          } else {
            spawnSparkles(bakery.doorX, bakery.doorY-22);
            cutState = CUT.ENTERING;
          }
        }
      }
      else if (cutState===CUT.ENTERING){
        const targetX = bakery.doorX - Math.round(player.w*0.55);
        const dx = targetX - player.x;
        const dir = Math.sign(dx);
        const maxMove = 0.11 * dtMs;
        const move = dir * Math.min(Math.abs(dx), maxMove);
        player.x += move;

        heroAlpha = Math.max(0, heroAlpha - 0.002 * dtMs);
        player.y = FLOOR_Y - player.h + FOOT_OFFSET;

        if (Math.abs(dx) <= maxMove && heroAlpha <= 0.02){
          cutState = CUT.DONE;
          showDlg(
            "How about you make Aleesha\nsome cookies whilst we wait\nfor the rain to die\ndown hehe",
            startBaking,
            { inset:"16% 16% 35% 24%", size:"clamp(20px,2.4vw,32px)" }
          );
        }
      }

      for (let i=sparkles.length-1;i>=0;i--){
        const s = sparkles[i];
        s.x += s.vx * step * 10;
        s.y += s.vy * step * 10;
        s.vy += 0.06 * step * 10;
        s.life -= (16.6*step);
        if (s.life <= 0) sparkles.splice(i,1);
      }
    }

    if (!modalActive && cutState===CUT.NONE && !presentScene){
      if (!endless){
        for (const o of obstacles){ if (overlap(player,o)){ triggerDead(); return; } }
      }
    }

    if (presentScene){
      const W = canvas.clientWidth, H = canvas.clientHeight || canvas.height;
      for (const f of fog){
        f.x += f.vx * (dtMs/16.6667);
        if (f.x < -f.r) { f.x = W + f.r; f.y = Math.random()*H*0.7; }
      }
    }

    if (confetti.length){
      for (let i=confetti.length-1;i>=0;i--){
        const p = confetti[i];
        p.x += p.vx * (dtMs/16.6667);
        p.y += p.vy * (dtMs/16.6667);
        p.vy += 0.08 * (dtMs/16.6667);
        p.rot += p.vr * (dtMs/16.6667);
        p.life -= dtMs;
        if (p.life <= 0) confetti.splice(i,1);
      }
    }

    frameTimer += step * 16.6667;
    if (frameTimer > FRAME_TIME){ frameTimer = 0; frame = player.onGround ? (frame+1)%SPRITE_FRAMES : 2; }

    if (storm){
      const W = canvas.clientWidth, H = canvas.clientHeight || canvas.height;
      for (const r of rain){ r.x -= 3*step; r.y += r.spd*step;
        if (r.y > H){ r.y = -r.len; r.x = Math.random()*W; }
        if (r.x < -10){ r.x = W + 10; } }
      if (nowMs - lastLightningMs > nextLightningMs){
        flashAlpha = 1; // flash only, no shake
        lastLightningMs = nowMs;
        nextLightningMs = 1200 + Math.random()*2200;
      }
      flashAlpha = Math.max(0, flashAlpha - 0.06*step);
      shakeTime = Math.max(0, shakeTime - dtMs);
    }

    if (score > highScore){
      highScore = score; highEl.textContent = highScore;
      localStorage.setItem("catRunnerHighScore", String(highScore));
    }
  }

  function startRound2(){
    bumpBase(20);
    setProgress();
    awaitingRound2 = false;
    round = 2; roundEl.textContent = "2";

    heroImg = heroR2;
    if (heroR2.complete) applySprite(heroR2, FATT2_W); else heroR2.onload = () => applySprite(heroR2, FATT2_W);

    checkpoint = { round:2, score:ROUND2_AT, jumps:0 };

    computeBgTileW(); resizeCanvas();

    storm = true;  seedRain();

    hud(true);
    setProgress();
    toast("‚≠ê Round 2! It‚Äôs storming ‚Äî checkpoint saved.");
    begin();
  }

  function currentBg(){
    if (round >= 4) return (bg4Img.complete ? bg4Img : (bg3Img.complete ? bg3Img : bg2Img));
    if (round >= 3) return (bg3Img.complete ? bg3Img : (bg2Img.complete ? bg2Img : bgImg));
    if (round === 2) return (bg2Img.complete ? bg2Img : bgImg);
    return bgImg;
  }

  /* Draw */
  function draw(){
    const W = canvas.clientWidth, H = canvas.clientHeight || canvas.height;
    ctx.save(); // no camera shake

    ctx.clearRect(0,0,W,H);

    if (bakery.visible && cutState !== CUT.NONE){
      if (bakeryImg.complete){
        const iw=bakeryImg.naturalWidth, ih=bakeryImg.naturalHeight;
        const s = Math.max(W/iw, H/ih);
        const dw = Math.ceil(iw*s), dh = Math.ceil(ih*s);
        const dx = Math.floor((W - dw)/2), dy = Math.floor((H - dh)/2);
        ctx.drawImage(bakeryImg, dx, dy, dw, dh);
      }
    } else {
      const bg = currentBg();
      if (bg && bg.complete && bg.naturalWidth > 0){
        const scale = H / bg.naturalHeight;
        const widthScaled = (Math.ceil(bg.naturalWidth * scale) | 0);
        if (bgTileW !== widthScaled) bgTileW = widthScaled;

        let x = Math.floor(bgX % bgTileW);
        if (x > 0) x -= bgTileW;
        while (x < W){ ctx.drawImage(bg, x, 0, bgTileW, H); x += bgTileW; }
      }
    }

    ctx.fillStyle = "#1f2340";
    ctx.fillRect(0, FLOOR_Y, W, H - FLOOR_Y);

    if (bakery.visible || presentScene){
      for (const s of sparkles){
        ctx.save(); ctx.translate(s.x|0, s.y|0); ctx.rotate(Math.PI/4);
        ctx.fillStyle = "#ffd053"; ctx.fillRect(-2,-2,4,4); ctx.restore();
      }
    }

    if (presentScene){
      const px = (present.x - Math.round(present.w/2)) | 0;
      const py = present.y | 0;
      const imgToDraw = presentOpened && openPresentImg.complete ? openPresentImg : presentImg;
      if (imgToDraw.complete){ ctx.drawImage(imgToDraw, px, py, present.w, present.h); }
    }

    if (cutState===CUT.NONE){ for (const o of obstacles){ ctx.drawImage(o.img, o.x|0, o.y|0, o.w|0, o.h|0); } }

    if (storm){
      ctx.strokeStyle = "rgba(200,220,255,0.45)"; ctx.lineWidth = 1.2; ctx.beginPath();
      for (const r of rain){ ctx.moveTo(r.x, r.y); ctx.lineTo(r.x-4, r.y+r.len); }
      ctx.stroke();
      if (flashAlpha > 0){ ctx.fillStyle = `rgba(255,255,255,${flashAlpha*0.6})`; ctx.fillRect(0,0,W,H); }
    }

    if (aleesha.visible && aleeshaImg.complete) {
      ctx.drawImage(
        aleeshaImg,
        aleesha.x | 0,
        aleesha.y | 0,
        aleesha.w | 0,
        aleesha.h | 0
      );
    }

    if (heroReady){
      const fx = (SPRITE_LAYOUT === "horizontal") ? frame * frameW : 0;
      const fy = (SPRITE_LAYOUT === "vertical")   ? frame * frameH : 0;
      const HTRIM = 6;
      const sxImg = fx - 1 * HTRIM, syImg = fy;
      const sw = frameW - 3 * HTRIM, sh = frameH;
      const dx = player.x | 0, dy = player.y | 0, dw = player.w | 0, dh = player.h | 0;

      ctx.save();
      ctx.globalAlpha = heroAlpha;
      ctx.drawImage(heroImg, sxImg, syImg, sw, sh, dx, dy, dw, dh);
      ctx.restore();
    }

    if (presentScene && fog.length){
      for (const f of fog){
        const grd = ctx.createRadialGradient(f.x, f.y, f.r*0.2, f.x, f.y, f.r);
        grd.addColorStop(0, `rgba(255,255,255,${f.a})`);
        grd.addColorStop(1, `rgba(255,255,255,0)`);
        ctx.fillStyle = grd;
        ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill();
      }
    }

    if (confetti.length){
      for (const p of confetti){
        ctx.save(); ctx.translate(p.x|0, p.y|0); ctx.rotate(p.rot);
        ctx.fillStyle = p.color; ctx.fillRect(-(p.w/2)|0, -(p.h/2)|0, p.w|0, p.h|0);
        ctx.restore();
      }
    }

    ctx.restore();
  }

  /* Helpers */
  function toast(msg){ const el = document.getElementById("toast"); el.textContent = msg; el.style.display = "block"; el.style.opacity = "1";
    setTimeout(()=>{ el.style.transition="opacity .5s"; el.style.opacity="0"; }, 1600);
    setTimeout(()=>{ el.style.display="none"; el.style.transition=""; }, 2200); }
  function overlap(a,b){ return !(a.x+a.w<b.x || a.x>b.x+b.w || a.y+a.h<b.y || a.y>b.y+b.h); }
  function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function show(el){ el.style.display="flex"; }
  function hide(el){ el.style.display="none"; }

  /* Checkpoint / modal */
  let checkpoint = null;
  function resetToCheckpoint(){
    if (!checkpoint) return;
    [winEl,overEl,cookEl,toastEl,dlgEl,letterEl].forEach(hide);

    modalActive=false; running=false; dead=false; inCooking=false;
    bakeryDone = (round >= 4);
    cutState = CUT.NONE; bakery.visible=false; sparkles.length=0; heroAlpha = 1;
    presentScene = false; fog = []; confetti = []; presentOpened = false;
    if (typeof aleesha !== "undefined") aleesha.visible = false;

    tLast=0; bgX=0; obstacles.length = 0;

    round = checkpoint.round || 2; roundEl.textContent = String(round);
    score = checkpoint.score ?? ((round===2)?ROUND2_AT:0); scoreEl.textContent = String(score);
    jumps = checkpoint.jumps ?? 0; jumpsEl.textContent = String(jumps);
    bumpBase(round >= 4 ? 40 : 20);
    setProgress();

    if (round === 4){
      storm = false;
      heroImg = heroR3;
      if (heroR3.complete) applySprite(heroR3, FATT3_W);
      else heroR3.onload = () => applySprite(heroR3, FATT3_W);
    } else {
      storm = true; seedRain();
      heroImg = heroR2;
      if (heroR2.complete) applySprite(heroR2, FATT2_W);
      else heroR2.onload = () => applySprite(heroR2, FATT2_W);
    }

    endless = !!checkpoint.postLetter ? false : endless;

    player.vy = 0; player.onGround = true; player.x = 120; player.y = FLOOR_Y - player.h + FOOT_OFFSET;

    computeBgTileW(); resizeCanvas();
    hud(true); toast(`‚è™ Resumed from checkpoint (Round ${round})`);
    begin();
  }

  function triggerDead(){
    if (modalActive) return;
    if (score > highScore){ highScore = score; localStorage.setItem("catRunnerHighScore", String(highScore)); highEl.textContent = highScore; }
    dead=true; running=false;
    retryCpBtn.style.display = checkpoint ? "inline-block" : "none";
    show(overEl);
  }

  document.getElementById("copy").onclick = async (e) => {
    e.preventDefault();
    try { await navigator.clipboard.writeText(GIFT_CODE);
      e.target.textContent="Copied!"; setTimeout(()=>e.target.textContent="Copy code",1500);
    } catch {}
  };
  document.getElementById("winContinue").onclick = (e)=>{ e.preventDefault(); hide(winEl); show(letterEl); };
  document.getElementById("closeWin").onclick   = (e)=>{ e.preventDefault(); hide(winEl); };

  document.getElementById("letterBtn").onclick = (e) => {
    e.preventDefault();
    hide(letterEl);

    // Leave the cutscene and resume normal gameplay
    presentScene = false;
    winUnlocked  = false;
    cutState     = CUT.NONE;
    modalActive  = false;

    // We want normal deaths after the letter
    endless = false;

    // Hide Aleesha NPC after present scene
    if (typeof aleesha !== "undefined") aleesha.visible = false;

    // Save a checkpoint AFTER the letter
    checkpoint = { round: 4, score, jumps, postLetter: true };

    hud(true);
    toast("Checkpoint saved ‚Äî keep running!");
    running = false;
    begin();
  };

  document.getElementById("retry").onclick      = (e)=>{ e.preventDefault(); hide(overEl); reset(); hud(true); begin(); nextGapPx = 0; };
  document.getElementById("retryCp").onclick    = (e)=>{ e.preventDefault(); resetToCheckpoint(); nextGapPx = 0; };

  /* Cooking mini-game */
  let inCooking = false;
  const cookOrder = ["butter","brown_sugar","egg","flour","choc_chips"];
  let cookStep = 0;

  const cookHint  = document.getElementById("cookHint");
  function bumpHint(){
    cookHint.classList.remove('bump');
    void cookHint.offsetWidth; // restart animation
    cookHint.classList.add('bump');
  }
  const bowlHotspot = document.getElementById("bowlHotspot");
  const bowlGlow = document.getElementById("bowlGlow");
  const layerButter = document.getElementById("layer-butter");
  const layerSugar  = document.getElementById("layer-sugar");
  const layerEgg    = document.getElementById("layer-egg");
  const layerFlour  = document.getElementById("layer-flour");
  const layerChips  = document.getElementById("layer-chips");
  const crackFX     = document.getElementById("crackFX");
  const tableItemsWrap = document.getElementById("tableItems");
  const stirRing = document.getElementById("stirRing");
  const stirText = document.getElementById("stirText");
  const doughEl = document.getElementById("dough");

  const ovenClock = document.getElementById("ovenClock");
  const sleepImg  = document.getElementById("sleepImg");
  const cookScene = document.getElementById("cookScene");

  function buildTable(){
    tableItemsWrap.innerHTML = "";
    const items = [
      {k:"butter", img:"butter.png", drag:"tiny_butter.png"},
      {k:"brown_sugar", img:"brown_sugar.png", drag:"brown_sugar_pile.png"},
      {k:"carton", img:"carton.png"},
      {k:"choc_chips", img:"choc_chips_pile.png", drag:"choc_chips.png"},
      {k:"flour", img:"flour.png", drag:"flour_pile.png"},
    ];
    items.sort(()=>Math.random()-0.5);
    for (const it of items){
      const b = document.createElement("button");
      b.className="itemBtn";
      b.setAttribute("data-k", it.k);
      if (it.drag) b.setAttribute("data-drag", it.drag);
      const img = document.createElement("img"); img.src = it.img; b.appendChild(img);
      tableItemsWrap.appendChild(b);
    }
  }

  function startBaking(){
    inCooking = true; running = false; hideGlobalUI();
    cookStep = 0; eggState = "none";
    cookHint.style.display = "inline-flex";
    cookHint.innerHTML = "<b>üßà butter first</b>";
    bumpHint();

    [layerButter, layerSugar, layerEgg, layerFlour, layerChips].forEach(el=>{ el.style.display="none"; el.style.opacity="1"; el.style.transform="translateX(-50%)"; });

    bowlHotspot.style.display = "block";
    document.getElementById("bowlClip").style.display = "block";
    stirRing.style.display = "none"; stirText.style.display = "none";
    doughEl.style.display = "none"; doughEl.style.opacity="0";
    crackFX.style.display = "none";

    document.getElementById("woodBoard").style.display = "block";
    document.getElementById("cookTable").style.display = "block";
    document.getElementById("cookGirl").style.display  = "block";
    document.getElementById("exitCook").style.display  = "block";

    tableItemsWrap.style.display = "flex";
    buildTable();

    cookEl.style.display = "flex";
    cookEl.style.background = "rgba(0,0,0,.85)";
  }

  /* deserter flow */
  const deserter = { active:false, count:0, limit:10 };
  function showDeserterSequence() {
    const steps = [
      { text: "u selfish prick, you couldnt even bring Aleesha cookies.", inset: "22% 14% 52% 18%", size:  "clamp(22px,2.6vw,36px)" },
      { text: "Even those weird snails you\neat would have been better\nthan this.", inset: "22% 14% 44% 18%", size:  "clamp(22px,2.6vw,36px)" },
      { text: "You failed, go back to\nyour home and start again.", inset: "22% 14% 35% 18%", size:  "clamp(22px,2.6vw,36px)" }
    ];

    let i = 0; modalActive = true; dlgEl.style.display = "flex"; dlgBubble.src = "bubble_2.png";
    function render(){ const { text, inset, size } = steps[i]; dlgText.textContent = text; dlgText.style.lineHeight="1.08"; dlgText.style.inset=inset; dlgText.style.fontSize=size; requestAnimationFrame(fitDlgText); }
    dlgNext.onclick = () => { i++; if (i < steps.length) render(); else { dlgEl.style.display = "none"; modalActive = false; dlgText.style.lineHeight="1.08"; reset(); hud(true); begin(); } };
    render();
  }

  function exitCookingEarly(){
    hide(cookEl);
    inCooking = false; bakeryDone = true; cutState = CUT.NONE; heroAlpha = 1;
    round = 2; roundEl.textContent = "2";
    heroImg = heroR2; if (heroR2.complete) applySprite(heroR2, FATT2_W); else heroR2.onload = () => applySprite(heroR2, FATT2_W);
    storm = true; seedRain();
    deserter.active = true; deserter.count = 0;
    player.vy = 0; player.onGround = true; player.x = 120; player.y = FLOOR_Y - player.h + FOOT_OFFSET;
    showGlobalUI(); hud(true); setProgress(); toast("Back to running‚Ä¶ (ig you hate Aleesha üòí)"); begin();
  }
  document.getElementById("exitCook").onclick = () => exitCookingEarly();

  /* Drag & drop / stirring / oven */
  function tweenToBowl(ghostEl, bowlEl, onDone){
    const g=ghostEl.getBoundingClientRect(), b=bowlEl.getBoundingClientRect();
    const gx=g.left, gy=g.top; const tx=b.left + b.width/2 - g.width/2; const ty=b.top  + b.height/2 - g.height/2;
    ghostEl.animate([{ transform:`translate(0px,0px) scale(1)`},{ transform:`translate(${tx-gx}px,${ty-gy}px) scale(.96)`}],
      { duration:180, easing:"cubic-bezier(.22,.72,.23,.99)", fill:"forwards" }).addEventListener("finish", ()=> onDone&&onDone());
  }
  function sparkleBurst(x, y, parent=document.body){
    for(let i=0;i<12;i++){ const s=document.createElement("span"); s.textContent = Math.random()<0.5 ? "‚ú®" : "‚ú¶";
      s.style.position="fixed"; s.style.left=x+"px"; s.style.top=y+"px"; s.style.pointerEvents="none"; s.style.fontSize=(12+Math.random()*8)+"px"; s.style.opacity="0.9"; parent.appendChild(s);
      const dx=(Math.random()*80-40), dy=(-20 - Math.random()*50), rot=(Math.random()*140-70);
      const anim = s.animate([{ transform:`translate(0,0) rotate(0deg)`, opacity:0.9 },{ transform:`translate(${dx}px,${dy}px) rotate(${rot}deg)`, opacity:0 }],
        { duration:600, easing:"cubic-bezier(.19,.62,.22,1)" });
      anim.addEventListener("finish", ()=> s.remove()); }
  }
  function endDragCleanup(){ bowlHotspot.classList.remove("pulse","magnet"); bowlGlow.style.opacity = 0; }

  let dragBtn = null, dragGhost = null, dragOffset = {x:0,y:0};
  let eggState = "none";
  function startGhost(btn, dragSrc, ev){
    const r = btn.getBoundingClientRect();
    dragOffset.x = ev.clientX - r.left; dragOffset.y = ev.clientY - r.top;
    dragGhost = btn.cloneNode(true);
    dragGhost.style.position = "fixed"; dragGhost.style.left = (ev.clientX - dragOffset.x) + "px"; dragGhost.style.top  = (ev.clientY - dragOffset.y) + "px";
    dragGhost.style.zIndex = 99; dragGhost.style.opacity = .95; dragGhost.style.cursor = "grabbing";
    const img = dragGhost.querySelector("img"); if (dragSrc) img.src = dragSrc;
    document.body.appendChild(dragGhost);
    bowlGlow.style.opacity = .6; bowlHotspot.classList.add("pulse");
  }
  function spawnEggButton(){
    if (eggState !== "none") return; eggState = "whole";
    const b = document.createElement("button"); b.className="itemBtn"; b.setAttribute("data-k","egg");
    const img = document.createElement("img"); img.src = "egg.png"; b.appendChild(img);
    tableItemsWrap.appendChild(b);
    b.addEventListener("pointerdown",(e)=>{ dragBtn = b; b.setPointerCapture(e.pointerId); startGhost(b, "egg.png", e); });
  }
  tableItemsWrap.addEventListener("pointerdown",(e)=>{ const btn = e.target.closest(".itemBtn"); if (!btn || btn.classList.contains("done")) return;
    const key = btn.getAttribute("data-k"); dragBtn = btn; btn.setPointerCapture(e.pointerId);
    if (key === "carton"){ btn.classList.add("done"); spawnEggButton(); toast("ü•ö An egg rolled out! Crack it on the table or bowl rim ‚Äî I‚Äôll drop it in."); return; }
    const dragSrc = btn.getAttribute("data-drag") || null; startGhost(btn, dragSrc, e); });
  window.addEventListener("pointermove",(e)=>{ if (!dragGhost) return;
    dragGhost.style.left = (e.clientX - dragOffset.x) + "px"; dragGhost.style.top  = (e.clientY - dragOffset.y) + "px";
    const near = Math.hypot((dragGhost.getBoundingClientRect().left + dragGhost.getBoundingClientRect().width/2) - (bowlHotspot.getBoundingClientRect().left + bowlHotspot.getBoundingClientRect().width/2),
                             (dragGhost.getBoundingClientRect().top + dragGhost.getBoundingClientRect().height/2) - (bowlHotspot.getBoundingClientRect().top + bowlHotspot.getBoundingClientRect().height/2)) < 110;
    bowlHotspot.classList.toggle("magnet", near); });
  window.addEventListener("pointerup",(e)=>{ if (!dragGhost) return;
    const key = dragBtn?.getAttribute("data-k") || "";
    const overStrict = (()=>{ const a=dragGhost.getBoundingClientRect(), b=bowlHotspot.getBoundingClientRect(); const pad=10;
      const ap={ left:a.left-pad, top:a.top-pad, right:a.right+pad, bottom:a.bottom+pad };
      return !(ap.right<b.left||ap.left>b.right||ap.bottom<b.top||ap.top>b.bottom); })();
    const nearCenter = (()=>{ const a=dragGhost.getBoundingClientRect(), b=bowlHotspot.getBoundingClientRect();
      const ax=a.left+a.width/2, ay=a.top+a.height/2; const bx=b.left+b.width/2, by=b.top+b.height/2; return Math.hypot(ax-bx, ay-by) < 110; })();
    const doSnap = nearCenter || overStrict;
    const cleanAndRemove = ()=>{ try{ document.body.removeChild(dragGhost); }catch{} dragGhost = null; endDragCleanup(); };

    if (key === "egg"){
      if (eggState === "whole"){
        const tableRect = document.getElementById("cookTable").getBoundingClientRect();
        const cracked = (e.clientY >= tableRect.top - 30) || overStrict || nearCenter;

        if (cracked){
          if (doSnap){
            tweenToBowl(dragGhost, bowlHotspot, ()=>{ crackFX.style.display = "block"; setTimeout(() => (crackFX.style.display = "none"), 500);
              layerEgg.style.display = "block"; document.querySelectorAll(`.itemBtn[data-k="egg"]`).forEach(b=>{ b.classList.add("done"); b.style.display="none"; });
              eggState = "none"; advanceIfCorrect("egg"); toast("üí• Cracked! Egg added.");
              const b = bowlHotspot.getBoundingClientRect(); sparkleBurst(b.left+b.width/2, b.top+b.height/2); cleanAndRemove(); dragBtn = null; });
          } else {
            crackFX.style.display = "block"; setTimeout(() => (crackFX.style.display = "none"), 500);
            layerEgg.style.display = "block"; document.querySelectorAll(`.itemBtn[data-k="egg"]`).forEach(b=>{ b.classList.add("done"); b.style.display="none"; });
            eggState = "none"; advanceIfCorrect("egg"); toast("üí• Cracked! Egg added."); cleanAndRemove(); dragBtn = null;
          }
        } else { toast("Crack the egg on the table or the bowl rim first!"); cleanAndRemove(); dragBtn = null; }
        return;
      }
    }

    const needed = cookOrder[cookStep];
    if (key !== needed){ toast(`Not yet! Next: ${pretty(needed)}.`); cleanAndRemove(); dragBtn = null; return; }
    if (!doSnap){ toast("Drop it into the bowl!"); cleanAndRemove(); dragBtn = null; return; }

    tweenToBowl(dragGhost, bowlHotspot, ()=>{ if (key === "butter") layerButter.style.display="block";
      if (key === "brown_sugar") layerSugar.style.display="block";
      if (key === "flour") layerFlour.style.display="block";
      if (key === "choc_chips") layerChips.style.display="block";
      dragBtn.classList.add("done"); advanceIfCorrect(key);
      const b = bowlHotspot.getBoundingClientRect(); sparkleBurst(b.left+b.width/2, b.top+b.height/2); cleanAndRemove(); dragBtn = null; });
  });

  function pretty(k){ return { butter:"üßà butter", brown_sugar:"üçØ brown sugar", egg:"ü•ö egg", flour:"üåæ flour", choc_chips:"üç´ choc chips" }[k] || k; }

  function advanceIfCorrect(key){
    if (key !== cookOrder[cookStep]) return;
    cookStep++; const next = cookOrder[cookStep];
    if (next){
      cookHint.innerHTML = `<b>${pretty(next)} next</b>`;
      bumpHint();
    } else {
      showDlg(
        "hold mouse down and stir\nclockwise in the bowl to mix.",
        enableStir,
        { inset:"20% 16% 40% 22%", size:"clamp(20px,2.4vw,32px)" }
      );
    }
  }

  /* STIRRING */
  let stirActive=false, stirAccum=0, lastAngle=null;
  function enableStir(){
    cookHint.innerHTML = "<b>Stir in circles!</b>";
    bumpHint();
    stirRing.style.display = "block"; stirText.style.display = "block";
    bowlHotspot.classList.remove("pulse","magnet");
    bowlHotspot.classList.add("active");
    stirAccum = 0; lastAngle = null;
    const hs = bowlHotspot;
    hs.addEventListener("pointerdown", stirStart, {passive:false});
    hs.addEventListener("pointermove", stirMove,  {passive:false});
    hs.addEventListener("pointerup",   stirEnd,   {passive:false});
    hs.addEventListener("pointercancel", stirEnd);
    hs.addEventListener("pointerleave",  stirEnd);
  }
  function stirStart(e){ e.preventDefault(); const hs=bowlHotspot; hs.setPointerCapture(e.pointerId); stirActive = true; lastAngle = angleAt(e.clientX, e.clientY); }
  function stirMove(e){
    if (!stirActive) return; e.preventDefault();
    const a = angleAt(e.clientX, e.clientY);
    if (lastAngle == null){ lastAngle = a; return; }
    let d = a - lastAngle; if (d > Math.PI) d -= Math.PI*2; if (d < -Math.PI) d += Math.PI*2;

    if (d > 0){
      stirAccum += d;
      const pct = Math.min(100, Math.round(stirAccum/(Math.PI*2*3)*100));
      stirText.textContent = `Stir‚Ä¶ ${pct}%`;

      const mixRatio = pct / 100;
      const t = Date.now();

      [layerButter, layerSugar, layerEgg, layerFlour, layerChips].forEach((el, i) => {
        if (el.style.display === "block") {
          el.style.opacity = String(1 - mixRatio * 0.85);
          el.style.transform = `translateX(-50%) rotate(${(i+1)*(Math.sin(t/200)*2)}deg) scale(${1 - mixRatio * 0.05})`;
        }
      });

      doughEl.style.display = "block";
      doughEl.style.opacity  = String(mixRatio);

      const swirlDeg = (stirAccum * 180 / Math.PI) % 360;
      doughEl.style.setProperty("--swirlDeg", `${swirlDeg}deg`);

      const bx = 50 + Math.cos(t / 180) * 2;
      const by = 58 + Math.sin(t / 220) * 2;
      doughEl.style.backgroundPosition = `${bx}% ${by}%`;

      if (pct >= 100) finishDough();
    }
    lastAngle = a;
  }
  function stirEnd(e){ stirActive=false; lastAngle=null; try{ bowlHotspot.releasePointerCapture(e.pointerId); }catch{} }
  function angleAt(x,y){ const r=bowlHotspot.getBoundingClientRect(); const cx=r.left+r.width/2, cy=r.top+r.height/2; return Math.atan2(y - cy, x - cx); }

  /* OVEN FLOW */
  function setCookBg(name){ cookScene.style.background = `#000 url("${name}.png") center/cover no-repeat`; }
  function hideMixingUI(){
    cookHint.style.display   = "none";
    tableItemsWrap.style.display = "none";
    bowlHotspot.style.display = "none";
    document.getElementById("bowlClip").style.display = "none";
    stirRing.style.display    = "none";
    stirText.style.display    = "none";
    doughEl.style.display     = "none";
    document.getElementById("woodBoard").style.display = "none";
    document.getElementById("cookTable").style.display = "none";
    document.getElementById("cookGirl").style.display  = "none";
    document.getElementById("exitCook").style.display  = "none";
  }
  function showClockSequenceNoText(done){
    ovenClock.style.display = "block";
    ovenClock.src = "clock_1.png";
    showContinueOnly(() => {
      ovenClock.src = "clock_2.png";
      showContinueOnly(() => {
        ovenClock.src = "clock_3.png";
        showContinueOnly(() => { ovenClock.style.display = "none"; done && done(); });
      });
    });
  }

  function finishDough(){
    stirRing.style.display="none"; stirText.style.display="none";
    ["layer-butter","layer-sugar","layer-egg","layer-flour","layer-chips"].forEach(id=>{ const el = document.getElementById(id); if (!el) return; el.style.opacity = "0"; el.style.display = "none"; });
    tableItemsWrap.style.display = "none"; tableItemsWrap.innerHTML = ""; eggState = "none"; crackFX.style.display = "none";
    if (dragGhost){ try{ dragGhost.remove(); }catch{} dragGhost = null; }
    bowlHotspot.classList.remove("pulse","magnet"); bowlGlow.style.opacity = 0;

    // reveal final dough
    doughEl.style.display = "block"; doughEl.style.opacity  = "1";
    cookHint.innerHTML = "<b>Ready to bake</b>";

    // follow-up dialog
    showDlg("Damn, that‚Äôs a lot!", () => {
      showDlg("Time to put it in the oven.", goOven1, { inset:"20% 14% 40% 18%", size:"clamp(22px, 2.5vw, 34px)" });
    }, { inset:"20% 16% 38% 22%", size:"clamp(20px,2.3vw,32px)" });
  }

  function goOven1(){ hideGlobalUI(); hideMixingUI(); cookEl.style.display = "flex"; cookEl.style.background = "rgba(0,0,0,.92)"; setCookBg("oven_1"); showContinueOnly(goOven2); }
  function goOven2(){
    hideGlobalUI(); cookEl.style.background = "rgba(0,0,0,.92)";
    setCookBg("oven_2");
    showContinueOnly(() => {
      showDlg("DONT TAKE A NAP\nLIKE YOU ALWAYS DO.", () => {
        showClockSequenceNoText(() => {
          sleepImg.src = "fatima_sleep.png"; sleepImg.style.display = "block";
          showDlg("OMG IT HAS BEEN SO LONG,\nAND THIS IDIOT\nHAS FALLEN ASLEEP", () => {
            sleepImg.style.display = "none";
            setCookBg("oven_3");
            showContinueOnly(() => {
              showDlg("YOU IDIOT, WAS SLEEP THAT\nIMPORTANT TO YOU?\nYou always mess up when you\nbake :(", () => {
                showDlg("Luckily theres extra dough,\nlets put another batch in the\noven, keep an eye on it\nok?!", () => {
                  setCookBg("oven_2");
                  showClockSequenceNoText(() => {
                    setCookBg("oven_4");
                    showContinueOnly(() => {
                      showDlg("YAY THEY'RE PERFECT,\nLETS GO TO ALEESHA QUICKLY!", () => { resumeAfterBaking(); }, { inset:"18% 16% 36% 20%", size:"clamp(20px,2.4vw,34px)" });
                    });
                  });
                }, { inset:"17% 12% 40% 16%", size:"clamp(20px,2.4vw,34px)" });
              }, { inset:"16% 10% 38% 14%", size:"clamp(18px,2.2vw,32px)" });
            });
          }, { inset:"18% 14% 38% 18%", size:"clamp(22px,2.6vw,36px)" });
        });
      }, { inset:"17% 12% 40% 16%", size:"clamp(20px,2.4vw,34px)" });
    });
  }

  function resumeAfterBaking(){
    hide(cookEl);
    inCooking = false; bakeryDone = true;
    bumpBase(40);
    jumps = 0;
    setProgress();

    cutState = CUT.NONE; bakery.visible = false; heroAlpha = 1;

    document.getElementById("tableItems").innerHTML = "";
    ["layer-butter","layer-sugar","layer-egg","layer-chips","layer-flour"].forEach(id=>{ const el=document.getElementById(id); if (el){ el.style.display="none"; el.style.opacity="1"; } });

    round = 4; roundEl.textContent = "4";
    storm = false; obstacles.length = 0;
    jumps = 0; jumpsEl.textContent = "0"; setProgress(); // reset bar for round 4

    heroImg = heroR3; if (heroR3.complete) applySprite(heroR3, FATT3_W); else heroR3.onload = () => applySprite(heroR3, FATT3_W);

    player.vy = 0; player.onGround = true; player.x = 120; player.y = FLOOR_Y - player.h + FOOT_OFFSET;

    deserter.active = false; deserter.count = 0; modalActive = false;

    checkpoint = { round:4, score:score, jumps:0 };

    computeBgTileW(); resizeCanvas();

    showGlobalUI(); hud(true);
    toast("‚≠ê Round 4! You have reached England innit ‚Äî checkpoint saved. YOU'RE ALMOST THERE!");
    begin();
  }

  /* Dlg sequence util */
  function showDlgSequence(messages,onDone){
    let i=0; modalActive=true; dlgEl.style.display="flex"; dlgBubble.src="bubble.png";
    function render(){ const m=messages[i]; const txt=(typeof m==="string")?m:m.text; const inset=(typeof m==="object"&&m.inset)?m.inset:null; const size=(typeof m==="object"&&m.size)?m.size:null;
      dlgText.textContent=txt; dlgText.style.lineHeight="1.08"; if (inset) dlgText.style.inset=inset; if (size) dlgText.style.fontSize=size; requestAnimationFrame(fitDlgText); }
    dlgNext.onclick=()=>{ i++; if (i<messages.length){ render(); } else { dlgEl.style.display="none"; modalActive=false; dlgText.style.lineHeight="1.08"; onDone&&onDone(); } };
    render();
  }

  /* Kickoff */
  resizeCanvas();
  reset();
  bakeryDone = false;
})();
</script>
</body>
</html>










